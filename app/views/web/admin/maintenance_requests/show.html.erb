<% content_for(:title) { "Request ##{@maintenance_request.id} - Prompt" } %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-900"><%= @maintenance_request.issue_type %></h1>
    <div class="flex gap-3">
      <%= link_to "Back", web_admin_maintenance_requests_path, class: "text-sm text-indigo-600 hover:text-indigo-800" %>
      <%= button_to "Delete", web_admin_maintenance_request_path(@maintenance_request), method: :delete,
            data: { turbo_confirm: "Delete this maintenance request? This cannot be undone." },
            class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700" %>
    </div>
  </div>

  <%# Progress Stepper %>
  <% steps = [
    { key: "submitted",              label: "Request Opened" },
    { key: "vendor_quote_requested", label: "Vendor Notified" },
    { key: "quote_accepted",         label: "Vendor Acknowledged" },
    { key: "in_progress",            label: "In Progress" },
    { key: "completed",              label: "Completed" }
  ]
  current_index = case @maintenance_request.status
    when "submitted"                        then 0
    when "vendor_quote_requested"           then 1
    when "quote_received", "quote_accepted" then 2
    when "in_progress"                      then 3
    when "completed"                        then 4
    when "quote_rejected"                   then 1
    else 0
    end
  %>
  <div class="mt-4 bg-white rounded-lg shadow p-6">
    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-4">Process Status</p>
    <div class="flex items-center">
      <% steps.each_with_index do |step, i| %>
        <div class="flex items-center <%= 'flex-1' unless i == steps.length - 1 %>">
          <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
            <%= current_index >= i ? 'bg-blue-600' : 'bg-gray-300' %>">
            <% if current_index > i %>
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
            <% elsif current_index == i %>
              <div class="w-2 h-2 rounded-full bg-white"></div>
            <% end %>
          </div>
          <% unless i == steps.length - 1 %>
            <div class="flex-1 h-1 mx-2 <%= current_index > i ? 'bg-blue-600' : 'bg-gray-300' %>"></div>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="flex mt-2">
      <% steps.each_with_index do |step, i| %>
        <div class="<%= i == steps.length - 1 ? 'text-right' : (i == 0 ? 'text-left' : 'text-center') %> flex-1">
          <span class="text-xs <%= current_index >= i ? 'text-gray-700' : 'text-gray-400' %>"><%= step[:label] %></span>
        </div>
      <% end %>
    </div>
    <% if @maintenance_request.quote_rejected? %>
      <p class="mt-3 text-xs font-medium text-orange-600">Quote rejected â€” select a different vendor</p>
    <% end %>
  </div>

  <div class="mt-4 grid grid-cols-1 sm:grid-cols-4 gap-4">
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-sm font-medium text-gray-500">Status</p>
      <p class="mt-1">
        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
          <%= case @maintenance_request.status
              when 'submitted' then 'bg-yellow-100 text-yellow-800'
              when 'completed' then 'bg-green-100 text-green-800'
              when 'in_progress' then 'bg-blue-100 text-blue-800'
              else 'bg-gray-100 text-gray-800'
              end %>">
          <%= @maintenance_request.status.humanize %>
        </span>
      </p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-sm font-medium text-gray-500">Severity</p>
      <p class="mt-1">
        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
          <%= case @maintenance_request.severity
              when 'low' then 'bg-green-100 text-green-800'
              when 'medium' then 'bg-yellow-100 text-yellow-800'
              when 'high' then 'bg-orange-100 text-orange-800'
              when 'urgent' then 'bg-red-100 text-red-800'
              else 'bg-gray-100 text-gray-800'
              end %>">
          <%= @maintenance_request.severity&.humanize || "N/A" %>
        </span>
      </p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-sm font-medium text-gray-500">Location</p>
      <p class="mt-1 text-lg font-semibold text-gray-900"><%= @maintenance_request.location || "N/A" %></p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-sm font-medium text-gray-500">Created</p>
      <p class="mt-1 text-lg font-semibold text-gray-900"><%= @maintenance_request.created_at.strftime("%b %d, %Y") %></p>
    </div>
  </div>

  <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900">Tenant</h2>
      <dl class="mt-3 space-y-2">
        <div>
          <dt class="text-sm text-gray-500">Name</dt>
          <dd class="text-sm font-medium text-gray-900"><%= @maintenance_request.tenant.name %></dd>
        </div>
        <div>
          <dt class="text-sm text-gray-500">Email</dt>
          <dd class="text-sm font-medium text-gray-900"><%= @maintenance_request.tenant.email %></dd>
        </div>
        <% if @maintenance_request.tenant.phone.present? %>
          <div>
            <dt class="text-sm text-gray-500">Phone</dt>
            <dd class="text-sm font-medium text-gray-900"><%= @maintenance_request.tenant.phone %></dd>
          </div>
        <% end %>
        <% if @maintenance_request.tenant.unit %>
          <div>
            <dt class="text-sm text-gray-500">Unit</dt>
            <dd class="text-sm font-medium text-gray-900"><%= @maintenance_request.tenant.unit.identifier %> - <%= @maintenance_request.tenant.unit.property.name || @maintenance_request.tenant.unit.property.address %></dd>
          </div>
        <% end %>
      </dl>
    </div>

    <% if @maintenance_request.assigned_vendor %>
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900">Assigned Vendor</h2>
        <dl class="mt-3 space-y-2">
          <div>
            <dt class="text-sm text-gray-500">Name</dt>
            <dd class="text-sm font-medium text-gray-900"><%= @maintenance_request.assigned_vendor.name %></dd>
          </div>
          <% if @maintenance_request.assigned_vendor.phone_number.present? %>
            <div>
              <dt class="text-sm text-gray-500">Phone</dt>
              <dd class="text-sm font-medium text-gray-900"><%= @maintenance_request.assigned_vendor.phone_number %></dd>
            </div>
          <% end %>
          <% if @maintenance_request.assigned_vendor.vendor_type.present? %>
            <div>
              <dt class="text-sm text-gray-500">Type</dt>
              <dd class="text-sm font-medium text-gray-900"><%= @maintenance_request.assigned_vendor.vendor_type %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    <% end %>
  </div>

  <% if @maintenance_request.conversation_summary.present? %>
    <div class="mt-6 bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900">Summary</h2>
      <p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"><%= @maintenance_request.conversation_summary %></p>
    </div>
  <% end %>

  <% filtered_chat = @maintenance_request.chat_history.reject { |m| m['role'] == 'system' || m['content']&.match?(/\AREADY_FOR_(PHOTOS|SUBMISSION)\z/) } %>
  <% if filtered_chat.present? %>
    <div class="mt-6 bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900">Chat Transcript</h2>
      <div class="mt-4 space-y-4">
        <% filtered_chat.each do |message| %>
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center <%= message['role'] == 'user' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600' %>">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <% if message['role'] == 'user' %>
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                <% else %>
                  <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                <% end %>
              </svg>
            </div>
            <div class="flex-1">
              <p class="text-xs font-semibold text-gray-500"><%= message['role'] == 'user' ? 'Tenant' : 'AI Assistant' %></p>
              <p class="mt-1 text-sm text-gray-700 whitespace-pre-wrap"><%= message['content'] %></p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @quotes.any? %>
    <div class="mt-6">
      <h2 class="text-lg font-semibold text-gray-900">Quotes</h2>
      <div class="mt-4 bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cost</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ETA</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% @quotes.each do |quote| %>
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900"><%= quote.vendor.name %></td>
                <td class="px-4 py-3 text-sm text-gray-900">$<%= number_with_precision(quote.estimated_cost, precision: 2) %></td>
                <td class="px-4 py-3 text-sm text-gray-500"><%= quote.work_description %></td>
                <td class="px-4 py-3 text-sm text-gray-500"><%= quote.estimated_arrival_time %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <% if @notes.any? %>
    <div class="mt-6">
      <h2 class="text-lg font-semibold text-gray-900">Notes</h2>
      <div class="mt-4 space-y-3">
        <% @notes.each do |note| %>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-start">
              <p class="text-sm font-medium text-gray-900"><%= note.user.name %> <span class="text-gray-400 font-normal">(<%= note.user.role.humanize %>)</span></p>
              <p class="text-xs text-gray-400"><%= note.created_at.strftime("%b %d, %Y %l:%M %p") %></p>
            </div>
            <p class="mt-1 text-sm text-gray-700"><%= note.content %></p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @maintenance_request.images.attached? %>
    <div class="mt-6">
      <h2 class="text-lg font-semibold text-gray-900">Images</h2>
      <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
        <% @maintenance_request.images.each do |image| %>
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <%= image_tag rails_blob_path(image, disposition: "inline"), class: "w-full h-48 object-cover" %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
