<% content_for(:title) { "Maintenance Request ##{@maintenance_request.id} - Prompt" } %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-900">Maintenance Request #<%= @maintenance_request.id %></h1>
    <%= link_to "Back to Dashboard", web_manager_dashboard_path, class: "text-sm text-blue-600 hover:text-blue-800" %>
  </div>

  <% if flash[:notice] %>
    <div class="mt-4 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg"><%= flash[:notice] %></div>
  <% end %>
  <% if flash[:alert] %>
    <div class="mt-4 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg"><%= flash[:alert] %></div>
  <% end %>

  <%# Progress Stepper %>
  <% is_closed = @maintenance_request.closed?
     steps = [
       { label: "Request\nOpened" },
       { label: "Vendor\nNotified" },
       { label: "Vendor\nAcknowledged" },
       { label: "In\nProgress" },
       { label: "Completed" }
     ]
     current_index = case @maintenance_request.status
       when "submitted"                        then 0
       when "vendor_quote_requested"           then 1
       when "quote_received", "quote_accepted" then 2
       when "in_progress"                      then 3
       when "completed"                        then 4
       when "quote_rejected"                   then 1
       when "closed"                           then 0
       else 0
       end
  %>
  <div class="mt-6 bg-white shadow rounded-lg p-6">
    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-4">Process Status</p>

    <% if is_closed %>
      <div class="flex items-center gap-3 py-2">
        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-gray-400">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-700">Request Closed</p>
          <p class="text-xs text-gray-500">This request was closed by the manager without completing the vendor flow.</p>
        </div>
      </div>
    <% else %>
      <div class="flex items-center">
        <% steps.each_with_index do |step, i| %>
          <div class="flex items-center <%= 'flex-1' unless i == steps.length - 1 %>">
            <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
              <%= current_index >= i ? 'bg-blue-600' : 'bg-gray-300' %>">
              <% if current_index > i %>
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
              <% elsif current_index == i %>
                <div class="w-2 h-2 rounded-full bg-white"></div>
              <% end %>
            </div>
            <% unless i == steps.length - 1 %>
              <div class="flex-1 h-1 mx-2 <%= current_index > i ? 'bg-blue-600' : 'bg-gray-300' %>"></div>
            <% end %>
          </div>
        <% end %>
      </div>
      <div class="flex mt-2">
        <% steps.each_with_index do |step, i| %>
          <div class="<%= i == steps.length - 1 ? 'text-right' : (i == 0 ? 'text-left' : 'text-center') %> flex-1">
            <span class="text-xs whitespace-pre-line leading-tight <%= current_index >= i ? 'text-gray-700 font-medium' : 'text-gray-400' %>"><%= step[:label] %></span>
          </div>
        <% end %>
      </div>
      <% if @maintenance_request.quote_rejected? %>
        <p class="mt-3 text-xs font-medium text-orange-600">Quote rejected — select a different vendor or send new quote requests</p>
      <% end %>

      <%# Contextual action buttons based on current status %>
      <% if @maintenance_request.quote_accepted? || @maintenance_request.quote_received? %>
        <div class="mt-4 pt-4 border-t border-gray-100">
          <%= button_to "Mark as In Progress", mark_in_progress_web_manager_maintenance_request_path(@maintenance_request), method: :post,
              data: { turbo_confirm: "Mark this request as in progress? The tenant will be notified." },
              class: "inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 cursor-pointer" %>
        </div>
      <% elsif @maintenance_request.in_progress? %>
        <div class="mt-4 pt-4 border-t border-gray-100">
          <%= button_to "Mark as Complete", mark_complete_web_manager_maintenance_request_path(@maintenance_request), method: :post,
              data: { turbo_confirm: "Mark this request as complete? The tenant will be notified." },
              class: "inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 cursor-pointer" %>
          <p class="mt-2 text-xs text-gray-500">The tenant can also mark this complete from the app.</p>
        </div>
      <% end %>
    <% end %>
  </div>

  <%# Request details %>
  <div class="mt-6 bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Details</h2>
    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
      <div>
        <dt class="text-sm font-medium text-gray-500">Issue Type</dt>
        <dd class="mt-1 text-sm text-gray-900"><%= @maintenance_request.issue_type %></dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Location</dt>
        <dd class="mt-1 text-sm text-gray-900"><%= @maintenance_request.location %></dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Tenant</dt>
        <dd class="mt-1 text-sm text-gray-900"><%= @maintenance_request.tenant.name %></dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Property / Unit</dt>
        <dd class="mt-1 text-sm text-gray-900">
          <% if @maintenance_request.tenant.unit %>
            <%= @maintenance_request.tenant.unit.property.name.presence || @maintenance_request.tenant.unit.property.address %> — Unit <%= @maintenance_request.tenant.unit.identifier %>
          <% else %>
            -
          <% end %>
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Severity</dt>
        <dd class="mt-1">
          <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
            <%= case @maintenance_request.severity
                when 'emergency' then 'bg-red-100 text-red-800'
                when 'urgent' then 'bg-orange-100 text-orange-800'
                when 'moderate' then 'bg-yellow-100 text-yellow-800'
                else 'bg-gray-100 text-gray-800'
                end %>">
            <%= @maintenance_request.severity.humanize %>
          </span>
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Status</dt>
        <dd class="mt-1">
          <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
            <%= case @maintenance_request.status
                when 'submitted' then 'bg-yellow-100 text-yellow-800'
                when 'vendor_quote_requested' then 'bg-purple-100 text-purple-800'
                when 'quote_received' then 'bg-blue-100 text-blue-800'
                when 'quote_accepted' then 'bg-green-100 text-green-800'
                when 'quote_rejected' then 'bg-red-100 text-red-800'
                when 'in_progress' then 'bg-blue-100 text-blue-800'
                when 'completed' then 'bg-green-100 text-green-800'
                when 'closed' then 'bg-gray-100 text-gray-600'
                else 'bg-gray-100 text-gray-800'
                end %>">
            <%= @maintenance_request.status.humanize %>
          </span>
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Assigned Vendor</dt>
        <dd class="mt-1 text-sm text-gray-900"><%= @maintenance_request.assigned_vendor&.name || "None" %></dd>
      </div>
    </dl>
  </div>

  <% if @maintenance_request.conversation_summary.present? %>
    <div class="mt-6 bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-2">Summary of Initial Request</h2>
      <p class="text-sm text-gray-700 whitespace-pre-wrap"><%= @maintenance_request.conversation_summary %></p>
    </div>
  <% end %>

  <% filtered_chat = @maintenance_request.chat_history.reject { |m| m['role'] == 'system' || m['content']&.match?(/\AREADY_FOR_(PHOTOS|SUBMISSION)\z/) } %>
  <% if filtered_chat.present? %>
    <div class="mt-6 bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900">Chat Transcript</h2>
      <div class="mt-4 space-y-4">
        <% filtered_chat.each do |message| %>
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center <%= message['role'] == 'user' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600' %>">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <% if message['role'] == 'user' %>
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                <% else %>
                  <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                <% end %>
              </svg>
            </div>
            <div class="flex-1">
              <p class="text-xs font-semibold text-gray-500"><%= message['role'] == 'user' ? 'Tenant' : 'AI Assistant' %></p>
              <p class="mt-1 text-sm text-gray-700 whitespace-pre-wrap"><%= message['content'] %></p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Attached photos %>
  <% if @maintenance_request.images.attached? %>
    <div class="mt-6 bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Photos</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        <% @maintenance_request.images.each do |image| %>
          <a href="<%= rails_blob_path(image, disposition: "inline") %>" target="_blank" class="block">
            <%= image_tag rails_blob_path(image, disposition: "inline"), class: "w-full h-40 object-cover rounded-lg border border-gray-200 hover:opacity-80 transition" %>
          </a>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Existing quote requests %>
  <div class="mt-6 bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Requests</h2>
    <% if @maintenance_request.quote_requests.any? %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sent At</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% @maintenance_request.quote_requests.each do |qr| %>
            <tr>
              <td class="px-4 py-2 text-sm text-gray-900"><%= qr.vendor.name %></td>
              <td class="px-4 py-2">
                <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
                  <%= case qr.status
                      when 'sent' then 'bg-blue-100 text-blue-800'
                      when 'quoted' then 'bg-green-100 text-green-800'
                      when 'declined' then 'bg-red-100 text-red-800'
                      when 'rejected' then 'bg-red-100 text-red-800'
                      else 'bg-gray-100 text-gray-800'
                      end %>">
                  <%= qr.status.humanize %>
                </span>
              </td>
              <td class="px-4 py-2 text-sm text-gray-500"><%= local_time(qr.created_at, format: :datetime) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-sm text-gray-400">No quote requests yet.</p>
    <% end %>
  </div>

  <%# Quotes received — comparison view %>
  <% sorted_quotes = @maintenance_request.quotes.includes(:vendor).order(:estimated_cost) %>
  <% if sorted_quotes.any? %>
    <% cheapest_id = sorted_quotes.first.id %>
    <% max_cost = sorted_quotes.maximum(:estimated_cost).to_f %>
    <div class="mt-6 bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Compare Quotes</h2>
      <% total_requests = @maintenance_request.quote_requests.size %>
      <% responded = sorted_quotes.size %>
      <% if responded < total_requests %>
        <p class="text-sm text-gray-500 mb-4"><%= responded %> of <%= total_requests %> vendors have responded.</p>
      <% end %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Estimated Cost</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Work Description</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Arrival</th>
              <% unless @maintenance_request.quote_accepted? || @maintenance_request.in_progress? || @maintenance_request.completed? || @maintenance_request.closed? %>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% sorted_quotes.each do |quote| %>
              <% is_cheapest = quote.id == cheapest_id && sorted_quotes.size > 1 %>
              <tr class="<%= 'border-l-4 border-green-500 bg-green-50' if is_cheapest %>">
                <td class="px-4 py-2 text-sm text-gray-900">
                  <%= quote.vendor&.name || "Unknown" %>
                  <% if is_cheapest %>
                    <span class="ml-1 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Best Price</span>
                  <% end %>
                </td>
                <td class="px-4 py-2 text-sm text-gray-900">
                  <% rating = quote.vendor&.rating.to_f %>
                  <% if rating > 0 %>
                    <div class="flex items-center gap-1">
                      <% 5.times do |i| %>
                        <% if i < rating.round %>
                          <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <% else %>
                          <svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        <% end %>
                      <% end %>
                      <span class="text-xs text-gray-500 ml-1"><%= format("%.1f", rating) %></span>
                    </div>
                  <% else %>
                    <span class="text-xs text-gray-400">No rating</span>
                  <% end %>
                </td>
                <td class="px-4 py-2 text-sm text-gray-900">
                  <div class="font-semibold"><%= number_to_currency(quote.estimated_cost) %></div>
                  <% if max_cost > 0 %>
                    <div class="mt-1 w-24 bg-gray-200 rounded-full h-2">
                      <div class="bg-blue-500 h-2 rounded-full" style="width: <%= (quote.estimated_cost.to_f / max_cost * 100).round %>%"></div>
                    </div>
                  <% end %>
                </td>
                <td class="px-4 py-2 text-sm text-gray-900"><%= quote.work_description %></td>
                <td class="px-4 py-2 text-sm text-gray-500">
                  <% if quote.estimated_arrival_time %>
                    <%= local_time(quote.estimated_arrival_time, format: :datetime) %>
                  <% else %>
                    -
                  <% end %>
                </td>
                <% unless @maintenance_request.quote_accepted? || @maintenance_request.in_progress? || @maintenance_request.completed? || @maintenance_request.closed? %>
                  <td class="px-4 py-2 text-sm">
                    <div class="flex items-center gap-2">
                      <%= button_to "Approve", approve_web_manager_quote_path(quote), method: :post, form: { class: "inline" }, class: "px-3 py-1 text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 cursor-pointer" %>
                      <%= button_to "Reject", reject_web_manager_quote_path(quote), method: :post, form: { class: "inline" }, class: "px-3 py-1 text-xs font-medium rounded-md text-white bg-red-600 hover:bg-red-700 cursor-pointer" %>
                    </div>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <%# Notes %>
  <div class="mt-6 bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Notes & Updates</h2>
    <% if @maintenance_request.notes.any? %>
      <div class="space-y-3 mb-4">
        <% @maintenance_request.notes.order(created_at: :asc).each do |note| %>
          <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex justify-between items-start">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-900"><%= note.user.name %></span>
                <% if note.user.tenant? %>
                  <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-green-100 text-green-800">Tenant</span>
                <% elsif note.user.property_manager? %>
                  <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Manager</span>
                <% end %>
              </div>
              <span class="text-xs text-gray-500"><%= local_time(note.created_at, format: :datetime) %></span>
            </div>
            <p class="mt-2 text-sm text-gray-700"><%= note.content %></p>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm text-gray-400 mb-4">No notes yet.</p>
    <% end %>

    <% unless @maintenance_request.completed? || @maintenance_request.closed? %>
      <%= form_with url: create_note_web_manager_maintenance_request_path(@maintenance_request), method: :post, class: "flex gap-3" do |f| %>
        <%= f.text_field :content, placeholder: "Add a note...", required: true, class: "flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" %>
        <%= f.submit "Send", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 cursor-pointer" %>
      <% end %>
    <% end %>
  </div>

  <%# Send quote requests form %>
  <% already_requested_ids = @maintenance_request.quote_requests.pluck(:vendor_id) %>
  <% requestable_vendors = @vendors.where.not(id: already_requested_ids) %>
  <% if requestable_vendors.any? && !@maintenance_request.completed? && !@maintenance_request.closed? && !@maintenance_request.in_progress? && !@maintenance_request.quote_accepted? %>
    <div class="mt-6 bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Request Quotes</h2>
      <%= form_with url: web_manager_maintenance_request_quote_requests_path(@maintenance_request), method: :post do |f| %>
        <div class="space-y-3">
          <% requestable_vendors.each do |vendor| %>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" name="vendor_ids[]" value="<%= vendor.id %>" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="text-sm text-gray-900"><%= vendor.name %></span>
              <span class="text-xs text-gray-500">(<%= vendor.vendor_type %>)</span>
            </label>
          <% end %>
        </div>
        <div class="mt-4">
          <%= f.submit "Send Quote Requests", class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 cursor-pointer" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <% unless @maintenance_request.completed? || @maintenance_request.closed? %>
    <div class="mt-6 bg-white shadow rounded-lg p-6 border border-red-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-2">Close Request</h2>
      <p class="text-sm text-gray-500 mb-4">Close this request without going through the vendor flow. The tenant will be notified with your explanation.</p>
      <%= form_with url: close_web_manager_maintenance_request_path(@maintenance_request), method: :post, class: "flex gap-3" do |f| %>
        <%= f.text_field :content, placeholder: "Explain why this request is being closed...", required: true, class: "flex-1 rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 text-sm" %>
        <%= f.submit "Close Request", data: { turbo_confirm: "Are you sure you want to close this request? The tenant will be notified." }, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 cursor-pointer" %>
      <% end %>
    </div>
  <% end %>
</div>
